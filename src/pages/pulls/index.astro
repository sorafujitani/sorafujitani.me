---
import BlogLayout from '@layouts/BlogLayout.astro';
import { GITHUB_USERNAME, PULLS_HIDDEN_REPOS, PULLS_SINCE, PULLS_OWN_REPOS } from '@lib/constants';
---

<BlogLayout title="Pulls" description="GitHub Pull Requests by Sora Fujitani">
  <div class="pulls-container">
    <h1>Pulls</h1>
    <p class="description">Public GitHub Pull Requests. <span class="since">from 2025-10</span></p>

    <div id="repos-filter" class="repos-filter" style="display:none;"></div>

    <div id="pulls-loading" class="skeleton-list">
      {Array.from({ length: 3 }).map(() => (
        <div class="skeleton-card">
          <div class="skeleton-header">
            <div class="skeleton-avatar" />
            <div class="skeleton-repo" />
          </div>
          <div class="skeleton-title" />
          <div class="skeleton-meta" />
        </div>
      ))}
    </div>

    <div id="pulls-error" class="error-state" style="display:none;">
      <p>Failed to load pull requests.</p>
      <button id="retry-btn" class="retry-button">Retry</button>
    </div>

    <div id="pulls-list" style="display:none;"></div>

    <nav id="pulls-pagination" class="pagination" style="display:none;"></nav>
  </div>
</BlogLayout>

<script define:vars={{ GITHUB_USERNAME, PULLS_HIDDEN_REPOS, PULLS_SINCE, PULLS_OWN_REPOS }}>
  const PER_PAGE = 16;
  const CACHE_TTL = 5 * 60 * 1000;
  const BASE_QUERY = `type:pr+author:${GITHUB_USERNAME}+is:public+created:>=${PULLS_SINCE}`;
  let currentPage = 1;
  let totalPages = 1;
  let activeRepo = null;

  function buildUrl(page) {
    let q = BASE_QUERY;
    if (activeRepo) q += `+repo:${activeRepo}`;
    return `https://api.github.com/search/issues?q=${q}&sort=created&order=desc&per_page=${PER_PAGE}&page=${page}`;
  }

  function cacheGet(key) {
    try {
      const raw = sessionStorage.getItem(key);
      if (!raw) return null;
      const { data, ts } = JSON.parse(raw);
      if (Date.now() - ts > CACHE_TTL) { sessionStorage.removeItem(key); return null; }
      return data;
    } catch { return null; }
  }

  function cacheSet(key, data) {
    try { sessionStorage.setItem(key, JSON.stringify({ data, ts: Date.now() })); } catch {}
  }

  async function cachedFetch(url) {
    const cached = cacheGet(url);
    if (cached) return cached;
    const res = await fetch(url);
    if (res.status === 403 || res.status === 429) throw new Error('rate_limit');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    cacheSet(url, data);
    return data;
  }

  function relativeTime(dateStr) {
    const now = Date.now();
    const diff = now - new Date(dateStr).getTime();
    const sec = Math.floor(diff / 1000);
    const min = Math.floor(sec / 60);
    const hour = Math.floor(min / 60);
    const day = Math.floor(hour / 24);
    const month = Math.floor(day / 30);
    const year = Math.floor(day / 365);

    if (year > 0) return `${year}年前`;
    if (month > 0) return `${month}ヶ月前`;
    if (day > 0) return `${day}日前`;
    if (hour > 0) return `${hour}時間前`;
    if (min > 0) return `${min}分前`;
    return 'たった今';
  }

  function extractRepo(htmlUrl) {
    const m = htmlUrl.match(/github\.com\/([^/]+\/[^/]+)\//);
    return m ? m[1] : '';
  }

  function prStatus(pr) {
    if (pr.pull_request?.merged_at) return 'merged';
    if (pr.state === 'open') return 'open';
    return 'closed';
  }

  function statusLabel(status) {
    if (status === 'merged') return 'Merged';
    if (status === 'open') return 'Open';
    return 'Closed';
  }

  function renderCard(pr) {
    const repo = extractRepo(pr.html_url);
    const owner = repo.split('/')[0];
    const status = prStatus(pr);
    const number = pr.number;
    const avatarUrl = `https://github.com/${owner}.png?size=40`;

    const card = document.createElement('article');
    card.className = 'pr-card';

    card.innerHTML = `
      <div class="pr-header">
        <img src="${avatarUrl}" alt="${owner}" class="pr-avatar" width="20" height="20" loading="lazy" />
        <a href="https://github.com/${repo}" target="_blank" rel="noopener noreferrer" class="pr-repo">${repo}</a>
        <span class="pr-badge pr-badge--${status}">${statusLabel(status)}</span>
      </div>
      <a href="${pr.html_url}" target="_blank" rel="noopener noreferrer" class="pr-title">
        ${pr.title} <span class="pr-number">#${number}</span>
      </a>
    `;

    return card;
  }

  function updatePagination(page, totalCount) {
    const pagination = document.getElementById('pulls-pagination');
    totalPages = Math.ceil(totalCount / PER_PAGE);

    if (totalPages <= 1) {
      pagination.style.display = 'none';
      return;
    }

    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.className = 'pagination-btn' + (i === page ? ' active' : '');
      btn.dataset.page = i;
      btn.textContent = i;
      pagination.appendChild(btn);
    }
    pagination.style.display = '';
  }

  function updateFilterButtons() {
    document.querySelectorAll('.repo-filter-btn').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.repo === (activeRepo || ''));
    });
  }

  function renderRepoFilters(items) {
    const ownSet = new Set(PULLS_OWN_REPOS);
    const externalRepos = new Map();
    items.forEach((pr) => {
      const repo = extractRepo(pr.html_url);
      const owner = repo.split('/')[0];
      if (!ownSet.has(repo) && owner !== GITHUB_USERNAME && !externalRepos.has(repo)) {
        externalRepos.set(repo, `https://github.com/${owner}.png?size=40`);
      }
    });

    const container = document.getElementById('repos-filter');
    container.innerHTML = '';

    const allBtn = document.createElement('button');
    allBtn.className = 'repo-filter-btn active';
    allBtn.dataset.repo = '';
    allBtn.textContent = 'All';
    container.appendChild(allBtn);

    PULLS_OWN_REPOS.forEach((repo) => {
      const owner = repo.split('/')[0];
      const btn = document.createElement('button');
      btn.className = 'repo-filter-btn';
      btn.dataset.repo = repo;
      btn.innerHTML = `<img src="https://github.com/${owner}.png?size=40" alt="" width="16" height="16" class="repo-filter-icon" loading="lazy" />${repo}`;
      container.appendChild(btn);
    });

    const sorted = [...externalRepos.entries()].sort((a, b) => a[0].localeCompare(b[0]));
    sorted.forEach(([repo, avatarUrl]) => {
      const btn = document.createElement('button');
      btn.className = 'repo-filter-btn';
      btn.dataset.repo = repo;
      btn.innerHTML = `<img src="${avatarUrl}" alt="" width="16" height="16" class="repo-filter-icon" loading="lazy" />${repo}`;
      container.appendChild(btn);
    });

    container.style.display = '';
  }

  async function fetchRepos() {
    try {
      const data = await cachedFetch(`https://api.github.com/search/issues?q=${BASE_QUERY}&per_page=100`);
      const hiddenSet = new Set(PULLS_HIDDEN_REPOS);
      const filtered = data.items.filter((pr) => {
        const repo = extractRepo(pr.html_url);
        return !hiddenSet.has(repo) && prStatus(pr) !== 'closed';
      });
      renderRepoFilters(filtered);
    } catch {}
  }

  async function fetchPulls(page) {
    currentPage = page || 1;
    const loading = document.getElementById('pulls-loading');
    const error = document.getElementById('pulls-error');
    const list = document.getElementById('pulls-list');
    const pagination = document.getElementById('pulls-pagination');

    loading.style.display = '';
    error.style.display = 'none';
    list.style.display = 'none';
    pagination.style.display = 'none';

    try {
      const data = await cachedFetch(buildUrl(currentPage));

      const hiddenSet = new Set(PULLS_HIDDEN_REPOS);
      const items = data.items.filter((pr) => {
        const repo = extractRepo(pr.html_url);
        return !hiddenSet.has(repo) && prStatus(pr) !== 'closed';
      });

      list.innerHTML = '';
      items.forEach((pr) => list.appendChild(renderCard(pr)));

      loading.style.display = 'none';
      list.style.display = '';
      updatePagination(currentPage, data.total_count);

      if (currentPage > 1) window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
      console.error('Failed to fetch pulls:', e);
      loading.style.display = 'none';
      error.querySelector('p').textContent = e.message === 'rate_limit'
        ? 'API rate limit exceeded. Please wait a moment.'
        : 'Failed to load pull requests.';
      error.style.display = '';
    }
  }

  document.getElementById('retry-btn').addEventListener('click', () => fetchPulls(currentPage));

  document.getElementById('pulls-pagination').addEventListener('click', (e) => {
    const btn = e.target.closest('.pagination-btn');
    if (btn) fetchPulls(Number(btn.dataset.page));
  });

  document.getElementById('repos-filter').addEventListener('click', (e) => {
    const btn = e.target.closest('.repo-filter-btn');
    if (!btn) return;
    const repo = btn.dataset.repo;
    activeRepo = repo || null;
    updateFilterButtons();
    fetchPulls(1);
  });

  fetchPulls(1).then(() => fetchRepos());
</script>

<style>
  .pulls-container {
    max-width: 680px;
  }

  h1 {
    font-size: 36px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: var(--color-heading);
  }

  .description {
    color: var(--color-text-muted);
    margin: 0 0 32px 0;
  }

  .since {
    font-size: 14px;
  }

  /* Repo filter buttons */
  #repos-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 32px;
  }

  #repos-filter :global(.repo-filter-btn) {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1.4;
  }

  #repos-filter :global(.repo-filter-btn:hover) {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  #repos-filter :global(.repo-filter-btn.active) {
    background: rgba(0, 216, 255, 0.1);
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  #repos-filter :global(.repo-filter-icon) {
    border-radius: 50%;
  }

  /* Skeleton */
  .skeleton-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .skeleton-card {
    padding-bottom: 24px;
    border-bottom: 1px solid var(--color-border);
  }

  .skeleton-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .skeleton-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--color-border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-repo {
    width: 160px;
    height: 14px;
    border-radius: 4px;
    background: var(--color-border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-title {
    width: 80%;
    height: 18px;
    border-radius: 4px;
    background: var(--color-border);
    margin-bottom: 8px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  .skeleton-meta {
    width: 60px;
    height: 12px;
    border-radius: 4px;
    background: var(--color-border);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* Error */
  .error-state {
    text-align: center;
    padding: 48px 0;
    color: var(--color-text-muted);
  }

  .error-state p {
    margin: 0 0 16px 0;
  }

  .retry-button {
    padding: 8px 20px;
    background: var(--color-tag-bg);
    color: var(--color-accent);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .retry-button:hover {
    background: var(--color-accent);
    color: var(--color-bg);
  }

  /* PR Cards (dynamic elements) */
  #pulls-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  #pulls-list :global(.pr-card) {
    padding-bottom: 24px;
    border-bottom: 1px solid var(--color-border);
  }

  #pulls-list :global(.pr-card:last-child) {
    border-bottom: none;
  }

  #pulls-list :global(.pr-header) {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  #pulls-list :global(.pr-avatar) {
    border-radius: 50%;
  }

  #pulls-list :global(.pr-repo) {
    font-size: 14px;
    color: var(--color-text-muted);
    text-decoration: none;
  }

  #pulls-list :global(.pr-repo:hover) {
    color: var(--color-accent);
  }

  #pulls-list :global(.pr-badge) {
    font-size: 12px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: auto;
  }

  #pulls-list :global(.pr-badge--merged) {
    background: rgba(163, 113, 247, 0.15);
    color: #a371f7;
  }

  #pulls-list :global(.pr-badge--open) {
    background: rgba(63, 185, 80, 0.15);
    color: #3fb950;
  }

  #pulls-list :global(.pr-badge--closed) {
    background: rgba(248, 81, 73, 0.15);
    color: #f85149;
  }

  #pulls-list :global(.pr-title) {
    display: block;
    font-size: 18px;
    font-weight: 600;
    color: var(--color-heading);
    text-decoration: none;
    margin-bottom: 4px;
    line-height: 1.4;
  }

  #pulls-list :global(.pr-title:hover) {
    color: var(--color-accent);
  }

  #pulls-list :global(.pr-number) {
    font-weight: 400;
    color: var(--color-text-muted);
    font-size: 16px;
  }

  #pulls-list :global(.pr-time) {
    display: block;
    font-size: 13px;
    color: var(--color-text-muted);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 40px;
  }

  .pagination :global(.pagination-btn) {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-tag-bg);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .pagination :global(.pagination-btn:hover) {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  .pagination :global(.pagination-btn.active) {
    background: var(--color-accent);
    color: var(--color-bg);
    border-color: var(--color-accent);
  }

  @media (max-width: 768px) {
    #pulls-list :global(.pr-title) {
      font-size: 16px;
    }

    .skeleton-title {
      width: 100%;
    }
  }
</style>
